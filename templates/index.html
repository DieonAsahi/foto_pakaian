<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logika Tombol (Versi DB)</title>
    <style>
        /* (CSS Anda sama seperti sebelumnya) */
        body { font-family: sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: auto; }
        .button-group { margin-bottom: 15px; }
        .button-group label { font-weight: bold; display: block; margin-bottom: 5px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; border: 1px solid #ccc; background-color: #f0f0f0; }
        button.active { background-color: #007bff; color: white; border-color: #007bff; }
        input[type="text"] { padding: 8px; font-size: 1em; }
        #save-button { background-color: #28a745; color: white; }
        #status { margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Tes Logika & Database</h1>

        <div class="button-group">
            <label>Gender User (dari Database):</label>
            <input type="text" id="gender-display" value="{{ user_gender }}" disabled>
            <input type="hidden" id="user-id" value="{{ user_id }}">
        </div>

        <div class="button-group">
            <label>Pilih Style:</label>
            <div id="style-buttons">
                </div>
        </div>

        <div class="button-group">
            <label>Pilih Kategori:</label>
            <div id="category-buttons">
                </div>
        </div>
        
        <div class="button-group">
            <label>Input Warna (Manual):</label>
            <input type="text" id="color-input" placeholder="Misal: Hitam">
        </div>

        <div class="button-group">
            <button id="save-button">Simpan ke Lemari</button>
            <div id="status"></div>
        </div>
    </div>

    <script>
        // Data awal
        const styles = ['Casual', 'Formal', 'Sport'];
        
        // Variabel global untuk menyimpan pilihan
        let selectedStyle = null;
        let selectedCategory = null;
        
        // Ambil data user dari HTML (yang dikirim Flask)
        const userGender = document.getElementById('gender-display').value;
        const userId = document.getElementById('user-id').value;

        // Ambil elemen div dari HTML
        const styleDiv = document.getElementById('style-buttons');
        const categoryDiv = document.getElementById('category-buttons');
        const colorInput = document.getElementById('color-input');
        const saveButton = document.getElementById('save-button');
        const statusDiv = document.getElementById('status');

        // Fungsi untuk mengambil data kategori dari server (app.py)
        async function fetchCategories(gender, style) {
            highlightButton(styleDiv, style);
            
            const response = await fetch('/get_categories', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ gender: gender, style: style })
            });

            if (!response.ok) {
                categoryDiv.innerHTML = "Gagal memuat kategori.";
                return;
            }

            const data = await response.json();
            const categories = data.categories;
            categoryDiv.innerHTML = '';
            selectedCategory = null; // Reset pilihan kategori

            categories.forEach(category => {
                const button = document.createElement('button');
                button.innerText = category;
                button.setAttribute('data-value', category);
                button.onclick = () => {
                    selectedCategory = category;
                    highlightButton(categoryDiv, category);
                };
                categoryDiv.appendChild(button);
            });
        }
        
        // Fungsi untuk menyimpan ke DB
        async function saveToWardrobe() {
            const color = colorInput.value;

            // Validasi sederhana
            if (!selectedStyle || !selectedCategory || !color) {
                statusDiv.innerText = "Error: Style, Kategori, dan Warna harus diisi!";
                statusDiv.style.color = 'red';
                return;
            }
            
            statusDiv.innerText = "Menyimpan...";
            statusDiv.style.color = 'blue';

            // Kirim data ke API /save_item
            const response = await fetch('/save_item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: userId,
                    style: selectedStyle,
                    category: selectedCategory,
                    color: color
                })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                statusDiv.innerText = result.message;
                statusDiv.style.color = 'green';
            } else {
                statusDiv.innerText = `Error: ${result.message}`;
                statusDiv.style.color = 'red';
            }
        }

        // Fungsi untuk menandai tombol yang aktif
        function highlightButton(parentDiv, activeText) {
            parentDiv.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeButton = parentDiv.querySelector(`button[data-value="${activeText}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }

        // --- Inisialisasi Aplikasi ---
        function init() {
            // Render tombol Style
            styles.forEach(style => {
                const button = document.createElement('button');
                button.innerText = style;
                button.setAttribute('data-value', style);
                button.onclick = () => {
                    selectedStyle = style;
                    fetchCategories(userGender, selectedStyle); // userGender sudah otomatis
                };
                styleDiv.appendChild(button);
            });
            
            // Listener untuk tombol Simpan
            saveButton.onclick = saveToWardrobe;
        }

        init();
    </script>
</body>
</html>